<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product['name'] }} - Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="homepage">
<header>
    <a href="{{ url_for('home') }}" class="home-icon">üè†</a>
    <div class="search-container">
        <form method="get" action="{{ url_for('search') }}" class="search-form">
            <input type="text" name="q" class="search-input" placeholder="Search guitars... (eg. Fender Stratocaster)">
            <button type="submit" class="search-button">Search</button>
        </form>
    </div>
    {% if current_user.is_authenticated %}
        <div class="user-menu">
            <span class="welcome-user">Welcome, {{ current_user.username }}!</span>
            <a href="{{ url_for('shopping_cart') }}" class="cart-button" aria-label="Shopping Cart">
                üõí Cart
                {% if cart_items and cart_items|length > 0 %}
                    <span class="cart-count">{{ cart_items|length }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('profile') }}" class="profile-link">Profile</a>
            <form method="post" action="{{ url_for('logout') }}" class="logout-form-inline">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    {% else %}
        <div class="auth-menu">
            <a href="{{ url_for('login') }}" class="auth-link login-link">Login</a>
            <a href="{{ url_for('register') }}" class="auth-link register-link">Register</a>
        </div>
    {% endif %}
</header>

<main class="dashboard" style="max-width: 1200px; margin: 0 auto; padding: 0 20px 60px;">
    <div class="product-detail" style="grid-column: 1 / -1; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(196, 63, 86, 0.12); overflow: hidden;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding: 20px;">
            <div class="product-gallery" style="position: relative;">
                <div style="background: #f9f9f9; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                    <img src="{{ product['image_url'] or url_for('static', filename='Images/FILLER.png') }}" 
                         alt="{{ product['name'] }}" 
                         style="width: 100%; height: auto; display: block; aspect-ratio: 1/1; object-fit: contain; padding: 20px;">
                </div>
                {% if product['stock'] > 0 %}
                <div style="position: absolute; top: 20px; left: 20px; background: rgba(46, 125, 50, 0.9); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500;">
                    In Stock ({{ product['stock'] }})
                </div>
                {% else %}
                <div style="position: absolute; top: 20px; left: 20px; background: rgba(211, 47, 47, 0.9); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500;">
                    Out of Stock
                </div>
                {% endif %}
            </div>
            
            <div class="product-info">
                <div style="margin-bottom: 24px;">
                    <span class="product-category" style="display: inline-block; color: #d65c6f; font-weight: 600; margin-bottom: 8px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                        {{ product['category'] }}
                    </span>
                    <h1 style="margin: 0 0 16px 0; font-size: 2.2rem; color: #222; font-weight: 700; line-height: 1.2;">
                        {{ product['name'] }}
                    </h1>
                    <div class="product-price" style="font-size: 2rem; font-weight: 800; color: #b7374a; margin-bottom: 24px;">
                        ${{ '%.2f'|format(product['price']) }}
                    </div>
                    
                    {% if product['description'] %}
                    <div class="product-short-desc" style="margin-bottom: 24px; font-size: 1.1rem; line-height: 1.6; color: #444;">
                        {{ product['description'] }}
                    </div>
                    {% endif %}
                    
                    <form method="post" action="{{ url_for('add_to_cart') }}" style="margin-top: 32px;">
                        <input type="hidden" name="product_id" value="{{ product['id'] }}">
                        <input type="hidden" name="quantity" value="1">
                        {% if product['stock'] > 0 %}
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px; font-style: italic;">
                                üí° To change quantity, go to your shopping cart after adding this item
                            </p>
                            <button type="submit" class="add-to-cart" style="width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 30px; background: linear-gradient(45deg, #f67280, #f79489); color: white; cursor: pointer; transition: all 0.3s ease;">
                                Add to Cart - ${{ '%.2f'|format(product['price']) }}
                            </button>
                        {% else %}
                        <button type="button" class="add-to-cart" disabled style="width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 30px; background: #e0e0e0; color: #9e9e9e; cursor: not-allowed;">
                            Out of Stock
                        </button>
                        {% endif %}
                    </form>
                </div>
                
                {% if detailed_description %}
                <div class="product-details" style="margin-top: 40px; padding-top: 24px; border-top: 1px solid #f0d8d8;">
                    <h3 style="margin: 0 0 16px 0; font-size: 1.5rem; color: #333; font-weight: 600;">Product Details</h3>
                    <div style="white-space: pre-wrap; line-height: 1.7; color: #555;">
                        {{ detailed_description }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
            
    </div>
    
    <!-- YouTube Videos Section -->
    {% if youtube_links %}
    <div class="youtube-section" style="margin-top: 40px; grid-column: 1 / -1; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(196, 63, 86, 0.12); padding: 40px;">
        <h2 style="margin: 0 0 30px 0; font-size: 1.8rem; color: #b7374a; font-weight: 700; position: relative; padding-bottom: 15px;">
            Video Demos
            <span style="position: absolute; bottom: 0; left: 0; width: 60px; height: 4px; background: linear-gradient(90deg, #f67280, #f79489); border-radius: 2px;"></span>
        </h2>
        <div class="video-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;">
            {% for video in youtube_links %}
            <a href="{{ video.url }}" target="_blank" rel="noopener noreferrer" class="video-card" style="text-decoration: none; color: inherit; display: block; transition: all 0.3s ease;">
                <div class="video-thumbnail" style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; background: #000;">
                    <div style="padding-top: 56.25%; position: relative;">
                        <img 
                            src="https://img.youtube.com/vi/{{ video.url.split('v=')[1] }}/hqdefault.jpg" 
                            alt="{{ video.title }}"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease;"
                            loading="lazy"
                            class="video-thumb"
                        >
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); transition: background 0.3s ease;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="#f44336" style="margin-left: 3px;">
                                    <path d="M8 5v14l11-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500;">
                            {{ video.duration }}
                        </div>
                    </div>
                </div>
                <div class="video-details" style="padding: 16px 8px 8px;">
                    <h3 style="margin: 0 0 6px 0; font-size: 1.05rem; line-height: 1.4; color: #222; font-weight: 600; display: -webkit-box; display: box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; box-orient: vertical; overflow: hidden; min-height: 2.8rem;">
                        {{ video.title }}
                    </h3>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px; font-weight: 500;">
                        {{ video.channel }}
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">
                        {{ "{:,}".format(video.views) }} views ‚Ä¢ {{ video.published }}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</main>

<style>
    .video-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .video-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
    }
    
    .video-card:hover .video-thumbnail {
        box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
    }
    
    .video-card:hover .video-thumbnail .video-thumb {
        transform: scale(1.05);
    }
    
    .video-card:hover .video-thumbnail > div {
        background: rgba(0,0,0,0.4);
    }
    
    .video-card:hover .video-thumbnail > div > div {
        transform: scale(1.1);
    }

    .video-card h3 {
        transition: color 0.2s;
    }

    .video-card:hover h3 {
        color: #d65c6f;
    }

    .add-to-cart {
        transition: all 0.3s ease !important;
    }
    
    .add-to-cart:not(:disabled):hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(214, 92, 111, 0.4) !important;
    }
    
    .in-cart {
        background: linear-gradient(45deg, #4CAF50, #66BB6A) !important;
        color: white !important;
        cursor: not-allowed !important;
    }
</style>

<!-- Store YouTube links as data attribute -->
<div id="youtube-data" data-youtube-links="{{ youtube_links|tojson|safe }}" style="display: none;"></div>
<!-- Store product price as data attribute -->
<div id="product-data" data-price="{{ '%.2f'|format(product['price']) }}" style="display: none;"></div>

<script>
    // Log YouTube links to console if they exist
    let youtubeLinks = [];
    
    // Get product price from data attribute
    const productData = document.getElementById('product-data');
    const productPrice = parseFloat(productData.getAttribute('data-price'));
    
    // Safely parse YouTube links from data attribute
    try {
        const youtubeDataElement = document.getElementById('youtube-data');
        if (youtubeDataElement) {
            const youtubeData = youtubeDataElement.getAttribute('data-youtube-links');
            if (youtubeData && youtubeData !== 'null' && youtubeData !== '[]') {
                youtubeLinks = JSON.parse(youtubeData);
            }
        }
    } catch (e) {
        console.log('Error parsing YouTube links:', e);
        youtubeLinks = [];
    }

    if (youtubeLinks && Array.isArray(youtubeLinks) && youtubeLinks.length > 0) {
        console.log('YouTube links for this product:', youtubeLinks);
    } else {
        console.log('No YouTube links found for this product');
    }

    // Handle add to cart form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[action*="add-to-cart"]');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent form submission

                const button = form.querySelector('button[type="submit"]');
                const productId = form.querySelector('input[name="product_id"]').value;

                // Disable the button to prevent multiple clicks
                button.disabled = true;
                button.textContent = 'Adding...';

                // Send the request to add the item to the cart
                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `product_id=${encodeURIComponent(productId)}&quantity=1`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.textContent = 'Added to cart!';
                        button.style.background = 'linear-gradient(45deg, #4CAF50, #66BB6A)';
                        // Reset button after 2 seconds
                        setTimeout(() => {
                            button.disabled = false;
                            button.textContent = 'Add to Cart - $' + productPrice.toFixed(2);
                            button.style.background = '';
                        }, 2000);
                    } else {
                        button.textContent = data.error || 'Failed to Add';
                        button.style.backgroundColor = '#f44336';
                        console.error('Error:', data.error);
                        // Re-enable the button on error
                        setTimeout(() => {
                            button.disabled = false;
                            button.textContent = 'Add to Cart - $' + productPrice.toFixed(2);
                            button.style.backgroundColor = '';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.textContent = 'Error';
                    button.style.backgroundColor = '#f44336';
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = 'Add to Cart - $' + productPrice.toFixed(2);
                        button.style.backgroundColor = '';
                    }, 2000);
                });
            });
        }
    });
</script>
</body>
</html>
