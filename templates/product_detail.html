<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product['name'] }} - Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="product-detail-page">
<header>
    <a href="{{ url_for('home') }}" class="home-icon">üè†</a> 
    <div class="search-container">
        <form method="get" action="{{ url_for('search') }}" class="search-form">
            <input type="text" name="q" class="search-input" placeholder="Search guitars... (eg. Fender Stratocaster)">
            <button type="submit" class="search-button">Search</button>
        </form>
    </div>
    <div class="menu-icon">‚ò∞</div>
</header>

<main class="dashboard" style="max-width:1200px;">
    <div class="product-detail" style="grid-column: 1 / -1; display:grid; grid-template-columns: 360px 1fr; gap: 24px; align-items:start;">
        <div>
            <img src="{{ product['image_url'] or url_for('static', filename='images/placeholder.jpg') }}" alt="{{ product['name'] }}" style="width:100%; height:auto; border-radius: 8px; object-fit:cover;">
        </div>
        <div>
            <div style="display:flex; justify-content:space-between; align-items:start; gap:16px;">
                <div>
                    <h1 style="margin:0 0 4px 0;">{{ product['name'] }}</h1>
                    <div style="color:#666; margin-bottom:8px;">{{ product['category'] }}</div>
                    <div style="font-weight:600; margin-bottom:12px;">${{ '%.2f'|format(product['price']) }}</div>
                    <p style="margin: 8px 0 12px 0;">{{ product['description'] or 'No short description.' }}</p>
                </div>
                <form method="post" action="{{ url_for('add_to_cart') }}">
                    <input type="hidden" name="product_id" value="{{ product['id'] }}">
                    {% if product['stock'] > 0 %}
                        {% if in_cart %}
                        <button type="button" class="add-to-cart in-cart" disabled>In Cart</button>
                        {% else %}
                        <button type="submit" class="add-to-cart">Add to cart</button>
                        {% endif %}
                    {% else %}
                    <button type="button" class="add-to-cart" disabled>Out of stock</button>
                    {% endif %}
                </form>
            </div>
            <div style="margin-top:16px;">
                <h3 style="margin: 0 0 8px 0;">Detailed description</h3>
                <p style="white-space:pre-wrap;">{{ detailed_description }}</p>
            </div>
            
            <!-- YouTube Videos Section -->
            {% if youtube_links %}
            <div class="youtube-section" style="margin-top: 2rem; grid-column: 1 / -1;">
                <h2 style="margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e0e0e0;">
                    Video Demos
                </h2>
                <div class="video-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                    {% for video in youtube_links %}
                    <div class="video-card" style="background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                        <a href="{{ video.url }}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                            <div class="video-thumbnail" style="position: relative; padding-top: 56.25%; background: #000;">
                                <img 
                                    src="https://img.youtube.com/vi/{{ video.url.split('v=')[1] }}/hqdefault.jpg" 
                                    alt="{{ video.title }}"
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                                    loading="lazy"
                                >
                                <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 4px; font-size: 0.8rem;">
                                    {{ video.duration }}
                                </div>
                            </div>
                            <div class="video-details" style="padding: 1rem;">
                                <h3 style="margin: 0 0 0.5rem; font-size: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 2.8rem;">
                                    {{ video.title }}
                                </h3>
                                <div style="font-size: 0.85rem; color: #606060; margin-bottom: 0.5rem;">
                                    {{ video.channel }}
                                </div>
                                <div style="font-size: 0.8rem; color: #909090;">
                                    {{ "{:,}".format(video.views) }} views ‚Ä¢ {{ video.published }}
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<style>
    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: 1fr !important;
        }

        .product-detail {
            grid-template-columns: 1fr !important;
        }
    }

    .video-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }

    .video-card h3 {
        transition: color 0.2s;
    }

    .video-card:hover h3 {
        color: #1a73e8;
    }

    .in-cart {
        background-color: #f44336 !important;
        color: white !important;
        cursor: not-allowed !important;
    }
</style>

<script>
    // Log YouTube links to console if they exist
    const youtubeLinks = {{ youtube_links|tojson|safe }};

    if (youtubeLinks && youtubeLinks.length > 0) {
        console.log('YouTube links for this product:', youtubeLinks);
    } else {
        console.log('No YouTube links found for this product');
    }

    // Handle add to cart form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[action*="add-to-cart"]');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent form submission

                const button = form.querySelector('button[type="submit"]');
                const productId = form.querySelector('input[name="product_id"]').value;

                // Disable the button to prevent multiple clicks
                button.disabled = true;
                button.textContent = 'Adding...';

                // Send the request to add the item to the cart
                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `product_id=${encodeURIComponent(productId)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.textContent = 'In Cart';
                        button.classList.add('in-cart');
                        button.disabled = true;
                        button.type = 'button'; // Change to button to prevent further submissions
                    } else {
                        if (data.error === 'Product already in cart') {
                            button.textContent = 'In Cart';
                            button.classList.add('in-cart');
                            button.disabled = true;
                            button.type = 'button';
                        } else {
                            button.textContent = 'Failed to Add';
                            button.style.backgroundColor = '#f44336';
                            console.error('Error:', data.error);
                            // Re-enable the button on error
                            setTimeout(() => {
                                button.disabled = false;
                                button.textContent = 'Add to Cart';
                                button.style.backgroundColor = '';
                            }, 2000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.textContent = 'Error';
                    button.style.backgroundColor = '#f44336';
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = 'Add to Cart';
                        button.style.backgroundColor = '';
                    }, 2000);
                });
            });
        }
    });
</script>
</body>
</html>
